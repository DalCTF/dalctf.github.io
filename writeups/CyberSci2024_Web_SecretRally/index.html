<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="manifest" href="/site.webmanifest"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#212830"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><title>Secret Rallies | Writeups | Status 418</title><style>pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!
  Theme: GitHub Dark
  Description: Dark theme as seen on github.com
  Author: github.com
  Maintainer: @Hirse
  Updated: 2021-05-15

  Outdated base version: https://github.com/primer/github-syntax-dark
  Current colors taken from GitHub's CSS
*/.hljs{color:#c9d1d9;background:#0d1117}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#ff7b72}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#d2a8ff}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-variable,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id{color:#79c0ff}.hljs-regexp,.hljs-string,.hljs-meta .hljs-string{color:#a5d6ff}.hljs-built_in,.hljs-symbol{color:#ffa657}.hljs-comment,.hljs-code,.hljs-formula{color:#8b949e}.hljs-name,.hljs-quote,.hljs-selector-tag,.hljs-selector-pseudo{color:#7ee787}.hljs-subst{color:#c9d1d9}.hljs-section{color:#1f6feb;font-weight:700}.hljs-bullet{color:#f2cc60}.hljs-emphasis{color:#c9d1d9;font-style:italic}.hljs-strong{color:#c9d1d9;font-weight:700}.hljs-addition{color:#aff5b4;background-color:#033a16}.hljs-deletion{color:#ffdcd7;background-color:#67060c}.content[data-astro-cid-tfjleern] a{color:#4985c1}.content[data-astro-cid-tfjleern] p,.content[data-astro-cid-tfjleern] h2{margin-bottom:24px}.content[data-astro-cid-tfjleern] h2 :not(:first-of-type){margin-top:48px}.content[data-astro-cid-tfjleern] img{max-width:100%;border-radius:8px}.content[data-astro-cid-tfjleern] code{background:#171c22;padding:.2em .5em;border-radius:6px;font-size:85%;margin:0;white-space:pre-wrap;word-wrap:break-word;word-break:break-word;overflow-wrap:anywhere}.content[data-astro-cid-tfjleern] pre{background:#171c22;border-radius:8px;margin:24px 0;display:block;padding:16px;white-space:pre-wrap;word-wrap:break-word;word-break:break-word;overflow-wrap:anywhere}.content[data-astro-cid-tfjleern] pre code{padding:0}
</style>
<link rel="stylesheet" href="/_astro/_page_.IxI8udFK.css">
<style>section[data-astro-cid-kggsjsm4]{display:block}[data-astro-cid-kggsjsm4][data-icon]{fill:#ffffffe6}[data-astro-cid-kggsjsm4][data-icon=github]{width:48px;height:48px;padding:8px}[data-astro-cid-kggsjsm4][data-icon=discord]{width:64px;height:64px}[data-astro-cid-kggsjsm4][data-icon=chevron]{width:16px;height:16px}[data-astro-cid-kggsjsm4][data-icon=archive]{width:36px;height:36px;padding:14px}a[data-astro-cid-kggsjsm4]{background:#171c22;justify-content:space-between;border-radius:8px;flex-direction:row;align-items:center;padding:16px;display:flex;color:inherit}a[data-astro-cid-kggsjsm4]:hover .right[data-astro-cid-kggsjsm4]{margin-right:16px}div[data-astro-cid-kggsjsm4]{flex-direction:row;align-items:center;display:flex;gap:16px}.right[data-astro-cid-kggsjsm4]{margin-right:24px;transition:.1s}
.wrapper[data-astro-cid-blwjyjpt]{border:2px solid var(--color);background:var(--background);display:inline-block;border-radius:16px;padding:0 8px;font-weight:500;color:var(--textColor);line-height:1.5rem;font-size:.75rem}
</style></head> <body> <section data-astro-cid-3ef6ksr2> <a class="logo" href="/" data-astro-cid-3ef6ksr2> <img src="/_astro/DalCTF_logo_cleanW.D7mbQLRA_ZwvbxW.webp" alt loading="eager" style="object-fit: contain;" data-astro-cid-3ef6ksr2="true" width="256" height="384" decoding="async"> </a> <div class="links" data-astro-cid-3ef6ksr2> <!-- <div class="dropdown">
      <a href="#" class="dropdown-toggle" role="button">Weekly Problems <span class="arrow">▼</span></a>
      <ul class="dropdown-menu">
        <li><a href="/weekly-problem">This Weeks</a></li>
        <li><a href="/past-weekly-problems">Past Problems</a></li>
      </ul>
    </div> --> <div class="dropdown" data-astro-cid-pqsyg2qg> <a href="#" class="dropdown-toggle" role="button" data-astro-cid-pqsyg2qg> Weekly Problems <span class="arrow" data-astro-cid-pqsyg2qg>▼</span> </a> <ul class="dropdown-menu" data-astro-cid-pqsyg2qg> <li data-astro-cid-pqsyg2qg><a href="/weekly-problem" data-astro-cid-pqsyg2qg>This Week&#39;s Problem(s)</a></li><li data-astro-cid-pqsyg2qg><a href="/past-weekly-problems" data-astro-cid-pqsyg2qg>Past Problems</a></li> </ul> </div>  <a href="/writeups" data-astro-cid-3ef6ksr2>Writeups</a><a href="/competitions" data-astro-cid-3ef6ksr2>Competitions</a> <a class="wrapper" href="https://discord.gg/4vEJJF6CQg" target="_blank" data-astro-cid-vnzlvqnm style="--textColor: #4985C1;--borderColor: #4985C1;--backgroundColor: transparent;"> Join us! </a>  </div> </section>    <section data-astro-cid-bbe6dxrz> <h3 data-astro-cid-bbe6dxrz>CyberSci Regional Qualifiers 2024-25</h3> <h1 data-astro-cid-bbe6dxrz>Secret Rallies</h1>  <div data-astro-cid-bbe6dxrz>  <div class="tags" data-astro-cid-tfjleern> <p class="wrapper" data-astro-cid-blwjyjpt style="--color: #0090FF;--textColor: #0090FF;--background: transparent;">Web</p> </div>  </div> </section>   <section data-astro-cid-kggsjsm4> <a href="https://github.com/DalCTF/CyberSci2024/tree/main/Web/SecretRally" target="_blank" data-astro-cid-kggsjsm4> <div class="left" data-astro-cid-kggsjsm4> <svg width="1.03em" height="1em" data-astro-cid-kggsjsm4="true" data-icon="github">   <symbol id="ai:local:github" viewBox="0 0 98 96"><path fill="currentColor" fill-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a47 47 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0" clip-rule="evenodd"/></symbol><use href="#ai:local:github"></use>  </svg> <p class="emphasis" data-astro-cid-kggsjsm4>View on GitHub</p> </div> <div class="right" data-astro-cid-kggsjsm4> <svg width="0.95em" height="1em" data-astro-cid-kggsjsm4="true" data-icon="chevron">   <symbol id="ai:local:chevron" viewBox="0 0 16 17"><g fill="none"><g clip-path="url(#a)"><path fill="currentColor" d="M13.057 8.48a.78.78 0 0 0-.251-.574L5.93 1.17a.8.8 0 0 0-.573-.226.777.777 0 0 0-.79.79.83.83 0 0 0 .225.565l6.32 6.18-6.32 6.18a.8.8 0 0 0-.225.565c0 .451.347.79.79.79a.78.78 0 0 0 .573-.234l6.875-6.728a.8.8 0 0 0 .251-.573z"/></g><defs><clipPath id="a"><path fill="currentColor" d="M0 .5h16v16H0z"/></clipPath></defs></g></symbol><use href="#ai:local:chevron"></use>  </svg> </div> </a> </section>  <span style="display: block; height: 64px"></span>  <section class="content" data-astro-cid-tfjleern> <div data-astro-cid-tfjleern><h2>Analysis</h2>
<p>The problem provides us a website that contains a login page requiring a username and a password. It also provides us the source code for the project, which is an ASP.NET application written in C#. The problem states that we are looking for the location of the &quot;Secret Rally&quot;. The flag follows the format <code>cybersci{...}</code> .</p>
<h2>Solution</h2>
<p>By analizing the code we first notice the presence of a middleware <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Middleware/AgentChecker.cs" target="_blank" rel="noopener noreferrer"><code>AgentChecker.cs</code></a>, which enforces that every request be sent with the header of <code>User-Agent</code> set to one of the valid values. From now on, assume that every request sent to the server includes the header <code>User-Agent: Chrome/</code> .</p>
<p>Since we can only see a login page, a reasonable location to explore in the code is the <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Auth/" target="_blank" rel="noopener noreferrer"><code>Auth</code></a> folder. While the JWT handling section in the <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Auth/JwtAuthHandler.cs" target="_blank" rel="noopener noreferrer"><code>JwtAuthHandler.cs</code></a> file seems fine, we may notice that the method <code>readJWTToken</code> is being used to read the contents of the JWT. According to the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens.jwt.jwtsecuritytokenhandler.readjwttoken" target="_blank" rel="noopener noreferrer">documentation</a>, this method does not validate the token, meaning that any signature is ignored. This means that we can forge a JWT with any signature and that will be considered valid by the system. Still in this context, we will notice that the code looks for the value under the claim with type <code>ClaimTypes.NameIdentifier</code>, which means that the claim key should be <code>http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier</code>. Therefore, to login into the system, we need a JWT with that claim key whose value is the username we want to login as.</p>
<p>By looking at the <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Program.cs" target="_blank" rel="noopener noreferrer"><code>Program.cs</code></a> file, we will find some initialization code, including a portion that adds a username with the format <code>username = &quot;admin&quot; + new Random().Next(1000, 2000)</code> and <code>password = RandomNumberGenerator.GetHexString(32)</code>. While a password with 32 bytes in hex is a bit much to brute-force, a number in the range 1000 to 2000 is well within range of a brute-force. Since we know how to craft JWT for given usernames, we can perform the brute-force with a username <code>admin</code> followed by a number between 1000 and 2000 until we successfully log into the system.</p>
<p>Once logged in, we are presented with a page called Dashboard that contains a list of rallies, but none of them contain the flag we are looking for. By analyzing the <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Models/Rally.cs" target="_blank" rel="noopener noreferrer"><code>Models/Rally.cs</code></a> file, we will see that a rally may or may not be hidden, leading us to believe that only the non-hidden rallies are actually being displayed in the dashboard. This is confirmed by looking at <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Pages/Dashboard.cshtml" target="_blank" rel="noopener noreferrer"><code>Pages/Dashboard.cshtml</code></a>, which contains the following <a href="https://learn.microsoft.com/en-us/dotnet/csharp/linq/" target="_blank" rel="noopener noreferrer">LINQ</a> query: <code>@foreach (var rally in Model.Rallies.Where(r =&gt; !r.Hidden))</code> .</p>
<p>The dashboard also contain a form for adding attendees to any of the rallies, which is handled in the file <a href="https://github.com/DalCTF/CyberSci2024/blob/main/Web/SecretRally/Source/src/SecretRally/SecretRally/Pages/Dashboard.cshtml.cs" target="_blank" rel="noopener noreferrer"><code>Pages/Dashboard.cshtml.cs</code></a>. Analyzing this file we will notice that the inclusion of the attendee is performed using the <code>ExecuteSqlRawAsync</code> with its parameters being appended to the code string, which opens up the opportunity for a SQL Injection. While the attendee name is filtered for valid characters and the rally ID must be sent as a number, the entrance code gets no such restrictions, giving us a parameter to perform our injection.</p>
<p>While we may be led to send the entrance code as an empty string, we must notice that the entrance code must be present in the database ahead of time, leading us to two options: performing the injection directly on the browser (since the entrance code will be loaded on page load), or parsing the HTML for the entrance code and sending it with the injection request. Given that there are other mechanisms for stopping CSRF provided by ASP.NET, complicating the code to perform the injection, it is recommended that the first option be taken. The code provided with this writeup uses the second option.</p>
<p>With a SQL injection entrypoint identified, we can perform the injection with the following:</p>
<pre><code class="hljs language-SQL">[ENTRANCE_CODE] <span class="hljs-operator">+</span> <span class="hljs-string">&#x27;, 1); UPDATE &quot;Rallies&quot; SET &quot;Hidden&quot;=false; -- -
</span></code></pre>
<p>Note that the syntax is specific to PostgreSQL, which is why the quotes around the table name and columns are required.</p>
<p>This will cause all of the rallies in the database to be considered non-hidden and, therefore, to be shown on the main dashboard. One of the rallies will have its location as <code>cybersci{th1s_1s_n0t_th3_0r1g1n4l_fl4g}</code>, which is this problem's flag.</p>
<p>In the provided code, there's a portion to extract the flag from the page after the injection is run and to revert the injection, setting the rally back to hidden. This is done in case the server is shared, so that we do not spoil the problem for other users.</p>
</div> </section>  <section data-astro-cid-sz7xmlte> <p data-astro-cid-sz7xmlte>
Last Updated in 2025<br data-astro-cid-sz7xmlte>
Halifax, NS<br data-astro-cid-sz7xmlte>
Canada
</p> </section>  </body></html> 